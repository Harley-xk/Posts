---
title: 关于本站-架构介绍
date: 2020-03-20 17:02
abstract: 生命不息，折腾不止。鉴于 Hexo 无法满足我的强迫症，修改主题又比较麻烦，以及 Github 感人的访问速度，遂打算自己从头开发个人网站，并部署到阿里云的服务器上去，这篇文章简单介绍了本站的基本结构...
tags: 
 - 随笔
 - Swift
 - Vapor
 - Vue
 - Linux
---

> 生命不息，折腾不止

## 引言

疫情依然没有结束，日常生活还是很难回到正轨，不过空余时间倒是多了...

于是，在春节通过 Hexo 把个人网站假设起来之后，感觉不是很符合我的预期（毕竟强迫症晚期），最终还是决定自己从头开发整个站点，同时也是一个很好的练习前后端协同开发的机会...

### 抛弃 Hexo

Hexo 本身可圈可点，不过始终找不到一个完全符合我自己审美的主题，另外大多数主题都使用 ejs 开发，而我本身只是个刚入前端圈的小白，暂时只会一点点 Vue，所以尝试自己修改时发现格外费力 --！

另外，原来的 Hexo 博客是放在 Github pages 上面的，鉴于目前国内访问 Github 那感人的速度，这显然不是长久之计...

大多数人都会选择一个成熟的博客框架来搭建个人站点，这样可以节省很多折腾的时间，而且开发一个完整网站所需的专业能力可能超出了很多人的技术范畴，抑或是有能力自己开发但是精力不足。

不过对于目前的我来说，正好有空闲的精力来做这个事情，而另外也可以继续锤炼一下自己的前端技能，于是折腾之路就此开始...

### 技术选型

#### 后端

后端其实没啥好选的，一开始只是因为 [Vapor 4](https://github.com/vapor/vapor/) 即将发布，打算找个练手项目趟坑，所以很自然的选择了 Vapor 4 作为后端技术栈。

> 结果发现 Vapor 4 的坑有点多 😂

#### 前端

前端目前只学了 [Vue](https://cn.vuejs.org/)（前端真的学不动啊），作为目前的三大框架之一，又有着丰富完善的文档和社区，所以也没有悬念。不过作为一个个人网站，SEO 的支持相对要求比较高，可能需要使用[服务端渲染(SSR)](https://ssr.vuejs.org/zh/)，所以选了基于 Vue 扩展的 [Nuxt.js](https://zh.nuxtjs.org/)，Nuxt 专门针对服务端渲染做了优化，并且简化了很多 Vue 的配置。

## 网站架构

网站分成三个部分，分别建了三个仓库：[**后端**](https://github.com/Harley-xk/Valog)、[**前端**](https://github.com/Harley-xk/nuxt-pages)和[**文章仓库**](https://github.com/Harley-xk/Posts)，都放到了 Github 上面，方便管理和维护。

### 文章仓库

文章是整个个人博客最核心的内容了，[Markdown](https://www.markdownguide.org/) 是必须的，不可能去用 doc 文档不是么。

文章仓库本身其实很简单，就是一个静态文件仓库，存放所有文章的 md 文件，当然还有文章引用到的图片等资源。

以前写技术文章的时候，图片是最头疼的问题，因为文章都要发到网络上，所以必须找个地方上传，可以选择的有 Github 和各种 OSS 服务。这些服务我之前都用过，最大的痛点是贴图和写文章没法同步工作...

另外放在 Github 依然存在访问速度的问题，而 OSS 服务大多有流量限制，超出需要付费，虽然不多，但是维护起来也很麻烦...

之前在简书上写文章，可以直接把图片拖到编辑器窗口中，编辑器会自动上传到简书的服务器，这一点很贴心，但是必须使用简书网页端的 markdown 编辑器，不能使用 VSCode 写 markdown 我是拒绝的。另外把文章转载到其他网站时也很不方便。

而自己搭博客时，可以将图片放在文章仓库的根目录下，在文章中直接引用相对地址，这样编辑文章时就能在预览中看到图片；后台在处理文章时同样只要把图片等资源拷贝到网站根目录下面，这样不需要额外处理，在网站上查看文章时就也能正常显示图片了。

比如我目前的文章目录结构如下所示，我如果想要在 `abc.md` 这个文章中引用图片，只需要将图片放到 `post-images/abc/image.png` 路径，然后在文档中写 `![image](/post-images/abc/image.png)`就可以了。

```plain
├── _posts
│   ├── 2019
│   │   ├── abc.md
│   │   ├── ...
│   │   └── xxx.md
│   └── ...
│       ├── ...
│       └── xxx.md
└── post-images
    ├── abc
    │   ├── image.png
    │   ├── ...
    │   └── xxx.png
    ├── ...
```

这样在部署网站时，只需要将 `post-image` 目录保持原样拷贝到网站根目录下面就可以了。

嗯，终于可以安心写文章了。

### 后端程序

后端目前的工作比较简单，主要是保存文章、评论、用户等数据，并提供相应的 API 接口。

后端使用 Vapor 4 作为框架，使用 Swift 编写，运行在阿里云的 Ubuntu 服务器上。后面会针对一些技术点详细展开讲讲 :)

#### 读取文章

服务器启动时，会执行预先设定好的脚本，通过 git 将文章仓库整个 clone 到本地。然后会遍历仓库的文件目录，找出所有的 markdown 文件。

首先写文章时按照主流规范，在 markdown 头部以 yaml 格式写好文章的属性，比如标题、日期、标签等信息。后端程序对每一个markdown 文档处理，读取配置信息，生成文章属性记录并更新到数据库。同时将资源目录拷贝到网站根目录下。

#### 钩子(Webhook)

当然不能每次发文章都重启服务器，文章仓库放在 Github 的好处是可以设置 [`Webhook`](https://developer.github.com/webhooks/)，这样每次写完文章 push 到仓库时就会触发钩子通知服务端，此时服务端就可以执行预先设定好的脚本，将文章更新 pull 下来，然后更新数据库和资源文件。

### 前端站点

前端站点也就是[本站](https://me.harley-xk.studio/)，负责数据的获取和展示。前端基于 Nuxt.js 开发，细节没啥多说的，网上关于 Vue 和 Nuxt 的文章以及很多了，而且他们官方文档也有很详尽的中文版本。

#### 体力活

关于前端，站在我一个小白的视角上看，感觉最主要的工作就是通过 CSS 调样式了，这里忍不住吐槽，写前端完全就TM是体力活啊。

> “你没有经历过 IE 时代，应该烧香了”，某前端大佬如是说 :)

不过吐槽规吐槽，现状已经是巨头们集体努力的结果了，可能在浏览器下面要把事情做好这真的很难吧:)

#### Markdown

继续说回前端，博客网站最主要的就是展示 Markdown 格式文章内容了，这里本站选择了主流的 [markdown-it](https://github.com/markdown-it/markdown-it) 插件，配合 [highlight.js](https://highlightjs.org/) 实现代码块的语法高亮，另外使用[markdown-it-anchor](https://github.com/valeriangalliat/markdown-it-anchor) 在处理 markdown 时为标题添加锚点，实现了文章的目录同步和导航定位。

相关的配置实现就不说了，并不复杂，网上也有很详细的教程。

## 用户和评论系统

目前用户认证系统已经做完了，但是还没有注册入口🙄，所以现在只有一个管理员用户用来供我自己查看后台统计数据:)

后期考虑会集成第三方登录系统，毕竟这种小网站估计很多人都不愿意专门注册账号的吧...

可以对文章发表匿名评论，不过请勿发表敏感言论，网站的所有访问都会记录 IP 地址👽

## 扩展

自己从头建设网站的好处是显而易见的，那就是有着无限扩展的可能性，而使用博客框架的话可扩展空间就很有限了。后面可以通过这个站点来实践一些试验性的想法

## 结束了

以上就是本站架构的简单介绍，虽然看似简单，实际上工作量还是很大的（特别是调 CSS，可能是我调的姿势不对？）
